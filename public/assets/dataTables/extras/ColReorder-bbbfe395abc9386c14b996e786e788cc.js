/*
 * File:        ColReorder.js
 * Version:     1.0.6
 * CVS:         $Id$
 * Description: Controls for column visiblity in DataTables
 * Author:      Allan Jardine (www.sprymedia.co.uk)
 * Created:     Wed Sep 15 18:23:29 BST 2010
 * Modified:    $Date$ by $Author$
 * Language:    Javascript
 * License:     GPL v2 or BSD 3 point style
 * Project:     DataTables
 * Contact:     www.sprymedia.co.uk/contact
 *
 * Copyright 2010-2011 Allan Jardine, all rights reserved.
 *
 * This source file is free software, under either the GPL v2 license or a
 * BSD style license, available at:
 *   http://datatables.net/license_gpl2
 *   http://datatables.net/license_bsd
 *
 */
(function(t,e,i){function n(t){for(var e=[],i=0,n=t.length;n>i;i++)e[t[i]]=i;return e}function s(t,e,i){var n=t.splice(e,1)[0];t.splice(i,0,n)}function o(t,e,i){for(var n=[],s=0,o=t.childNodes.length;o>s;s++)t.childNodes[s].nodeType==1&&n.push(t.childNodes[s]);var a=n[e];null!==i?t.insertBefore(a,n[i]):t.appendChild(a)}t.fn.dataTableExt.oApi.fnColReorder=function(e,i,a){var r,l,h,u,c,d,p=e.aoColumns.length;if(i!=a){if(0>i||i>=p)return this.oApi._fnLog(e,1,"ColReorder 'from' index is out of bounds: "+i),void 0;if(0>a||a>=p)return this.oApi._fnLog(e,1,"ColReorder 'to' index is out of bounds: "+a),void 0;var f=[];for(r=0,l=p;l>r;r++)f[r]=r;s(f,i,a);var m=n(f);for(r=0,l=e.aaSorting.length;l>r;r++)e.aaSorting[r][0]=m[e.aaSorting[r][0]];if(e.aaSortingFixed!==null)for(r=0,l=e.aaSortingFixed.length;l>r;r++)e.aaSortingFixed[r][0]=m[e.aaSortingFixed[r][0]];for(r=0,l=p;l>r;r++)for(d=e.aoColumns[r],h=0,u=d.aDataSort.length;u>h;h++)d.aDataSort[h]=m[d.aDataSort[h]];for(r=0,l=p;l>r;r++)d=e.aoColumns[r],typeof d.mDataProp=="number"&&(d.mDataProp=m[d.mDataProp],d.fnGetData=e.oApi._fnGetObjectDataFn(d.mDataProp),d.fnSetData=e.oApi._fnSetObjectDataFn(d.mDataProp));if(e.aoColumns[i].bVisible){var g=this.oApi._fnColumnIndexToVisible(e,i),v=null;for(r=i>a?a:a+1;null===v&&p>r;)v=this.oApi._fnColumnIndexToVisible(e,r),r++;for(c=e.nTHead.getElementsByTagName("tr"),r=0,l=c.length;l>r;r++)o(c[r],g,v);if(e.nTFoot!==null)for(c=e.nTFoot.getElementsByTagName("tr"),r=0,l=c.length;l>r;r++)o(c[r],g,v);for(r=0,l=e.aoData.length;l>r;r++)e.aoData[r].nTr!==null&&o(e.aoData[r].nTr,g,v)}for(s(e.aoColumns,i,a),s(e.aoPreSearchCols,i,a),r=0,l=e.aoData.length;l>r;r++)t.isArray(e.aoData[r]._aData)&&s(e.aoData[r]._aData,i,a),s(e.aoData[r]._anHidden,i,a);for(r=0,l=e.aoHeader.length;l>r;r++)s(e.aoHeader[r],i,a);if(e.aoFooter!==null)for(r=0,l=e.aoFooter.length;l>r;r++)s(e.aoFooter[r],i,a);for(r=0,l=p;l>r;r++)t(e.aoColumns[r].nTh).unbind("click"),this.oApi._fnSortAttachListener(e,e.aoColumns[r].nTh,r);t(e.oInstance).trigger("column-reorder",[e,{iFrom:i,iTo:a,aiInvertMapping:m}]),typeof e.oInstance._oPluginFixedHeader!="undefined"&&e.oInstance._oPluginFixedHeader.fnUpdate()}},ColReorder=function(t,e){return this.CLASS&&this.CLASS=="ColReorder"||alert("Warning: ColReorder must be initialised with the keyword 'new'"),"undefined"==typeof e&&(e={}),this.s={dt:null,init:e,fixed:0,dropCallback:null,mouse:{startX:-1,startY:-1,offsetX:-1,offsetY:-1,target:-1,targetIndex:-1,fromIndex:-1},aoTargets:[]},this.dom={drag:null,pointer:null},this.s.dt=t.fnSettings(),this._fnConstruct(),ColReorder.aoInstances.push(this),this},ColReorder.prototype={fnReset:function(){for(var t=[],e=0,i=this.s.dt.aoColumns.length;i>e;e++)t.push(this.s.dt.aoColumns[e]._ColReorder_iOrigCol);this._fnOrderColumns(t)},_fnConstruct:function(){var t,e,i=this;for(typeof this.s.init.iFixedColumns!="undefined"&&(this.s.fixed=this.s.init.iFixedColumns),typeof this.s.init.fnReorderCallback!="undefined"&&(this.s.dropCallback=this.s.init.fnReorderCallback),t=0,e=this.s.dt.aoColumns.length;e>t;t++)t>this.s.fixed-1&&this._fnMouseListener(t,this.s.dt.aoColumns[t].nTh),this.s.dt.aoColumns[t]._ColReorder_iOrigCol=t;this.s.dt.oApi._fnCallbackReg(this.s.dt,"aoStateSaveParams",function(t,e){i._fnStateSave.call(i,e)},"ColReorder_State");var s=null;if(typeof this.s.init.aiOrder!="undefined"&&(s=this.s.init.aiOrder.slice()),this.s.dt.oLoadedState&&typeof this.s.dt.oLoadedState.ColReorder!="undefined"&&this.s.dt.oLoadedState.ColReorder.length==this.s.dt.aoColumns.length&&(s=this.s.dt.oLoadedState.ColReorder),s)if(i.s.dt._bInitComplete){var o=n(s);i._fnOrderColumns.call(i,o)}else{var a=!1;this.s.dt.aoDrawCallback.push({fn:function(){if(!i.s.dt._bInitComplete&&!a){a=!0;var t=n(s);i._fnOrderColumns.call(i,t)}},sName:"ColReorder_Pre"})}},_fnOrderColumns:function(e){if(e.length!=this.s.dt.aoColumns.length)return this.s.dt.oInstance.oApi._fnLog(this.s.dt,1,"ColReorder - array reorder does not match known number of columns. Skipping."),void 0;for(var i=0,n=e.length;n>i;i++){var o=t.inArray(i,e);i!=o&&(s(e,o,i),this.s.dt.oInstance.fnColReorder(o,i))}(this.s.dt.oScroll.sX!==""||this.s.dt.oScroll.sY!=="")&&this.s.dt.oInstance.fnAdjustColumnSizing(),this.s.dt.oInstance.oApi._fnSaveState(this.s.dt)},_fnStateSave:function(e){var i,n,s,o=this.s.dt;for(i=0;i<e.aaSorting.length;i++)e.aaSorting[i][0]=o.aoColumns[e.aaSorting[i][0]]._ColReorder_iOrigCol;for(aSearchCopy=t.extend(!0,[],e.aoSearchCols),e.ColReorder=[],i=0,n=o.aoColumns.length;n>i;i++)s=o.aoColumns[i]._ColReorder_iOrigCol,e.aoSearchCols[s]=aSearchCopy[i],e.abVisCols[s]=o.aoColumns[i].bVisible,e.ColReorder.push(s)},_fnMouseListener:function(e,i){var n=this;t(i).bind("mousedown.ColReorder",function(t){t.preventDefault(),n._fnMouseDown.call(n,t,i)})},_fnMouseDown:function(e,n){var s=this,o=this.s.dt.aoColumns,a=e.target.nodeName=="TH"?e.target:t(e.target).parents("TH")[0],r=t(a).offset();this.s.mouse.startX=e.pageX,this.s.mouse.startY=e.pageY,this.s.mouse.offsetX=e.pageX-r.left,this.s.mouse.offsetY=e.pageY-r.top,this.s.mouse.target=n,this.s.mouse.targetIndex=t("th",n.parentNode).index(n),this.s.mouse.fromIndex=this.s.dt.oInstance.oApi._fnVisibleToColumnIndex(this.s.dt,this.s.mouse.targetIndex),this.s.aoTargets.splice(0,this.s.aoTargets.length),this.s.aoTargets.push({x:t(this.s.dt.nTable).offset().left,to:0});for(var l=0,h=0,u=o.length;u>h;h++)h!=this.s.mouse.fromIndex&&l++,o[h].bVisible&&this.s.aoTargets.push({x:t(o[h].nTh).offset().left+t(o[h].nTh).outerWidth(),to:l});this.s.fixed!==0&&this.s.aoTargets.splice(0,this.s.fixed),t(i).bind("mousemove.ColReorder",function(t){s._fnMouseMove.call(s,t)}),t(i).bind("mouseup.ColReorder",function(t){s._fnMouseUp.call(s,t)})},_fnMouseMove:function(t){if(this.dom.drag===null){if(Math.pow(Math.pow(t.pageX-this.s.mouse.startX,2)+Math.pow(t.pageY-this.s.mouse.startY,2),.5)<5)return;this._fnCreateDragNode()}this.dom.drag.style.left=t.pageX-this.s.mouse.offsetX+"px",this.dom.drag.style.top=t.pageY-this.s.mouse.offsetY+"px";for(var e=!1,i=1,n=this.s.aoTargets.length;n>i;i++)if(t.pageX<this.s.aoTargets[i-1].x+(this.s.aoTargets[i].x-this.s.aoTargets[i-1].x)/2){this.dom.pointer.style.left=this.s.aoTargets[i-1].x+"px",this.s.mouse.toIndex=this.s.aoTargets[i-1].to,e=!0;break}e||(this.dom.pointer.style.left=this.s.aoTargets[this.s.aoTargets.length-1].x+"px",this.s.mouse.toIndex=this.s.aoTargets[this.s.aoTargets.length-1].to)},_fnMouseUp:function(){t(i).unbind("mousemove.ColReorder"),t(i).unbind("mouseup.ColReorder"),this.dom.drag!==null&&(i.body.removeChild(this.dom.drag),i.body.removeChild(this.dom.pointer),this.dom.drag=null,this.dom.pointer=null,this.s.dt.oInstance.fnColReorder(this.s.mouse.fromIndex,this.s.mouse.toIndex),(this.s.dt.oScroll.sX!==""||this.s.dt.oScroll.sY!=="")&&this.s.dt.oInstance.fnAdjustColumnSizing(),this.s.dropCallback!==null&&this.s.dropCallback.call(this),this.s.dt.oInstance.oApi._fnSaveState(this.s.dt))},_fnCreateDragNode:function(){var e=this;for(this.dom.drag=t(this.s.dt.nTHead.parentNode).clone(!0)[0],this.dom.drag.className+=" DTCR_clonedTable";this.dom.drag.getElementsByTagName("caption").length>0;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("caption")[0]);for(;this.dom.drag.getElementsByTagName("tbody").length>0;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("tbody")[0]);for(;this.dom.drag.getElementsByTagName("tfoot").length>0;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("tfoot")[0]);t("thead tr:eq(0)",this.dom.drag).each(function(){t("th:not(:eq("+e.s.mouse.targetIndex+"))",this).remove()}),t("tr",this.dom.drag).height(t("tr:eq(0)",e.s.dt.nTHead).height()),t("thead tr:gt(0)",this.dom.drag).remove(),t("thead th:eq(0)",this.dom.drag).each(function(){this.style.width=t("th:eq("+e.s.mouse.targetIndex+")",e.s.dt.nTHead).width()+"px"}),this.dom.drag.style.position="absolute",this.dom.drag.style.top="0px",this.dom.drag.style.left="0px",this.dom.drag.style.width=t("th:eq("+e.s.mouse.targetIndex+")",e.s.dt.nTHead).outerWidth()+"px",this.dom.pointer=i.createElement("div"),this.dom.pointer.className="DTCR_pointer",this.dom.pointer.style.position="absolute",this.s.dt.oScroll.sX===""&&this.s.dt.oScroll.sY===""?(this.dom.pointer.style.top=t(this.s.dt.nTable).offset().top+"px",this.dom.pointer.style.height=t(this.s.dt.nTable).height()+"px"):(this.dom.pointer.style.top=t("div.dataTables_scroll",this.s.dt.nTableWrapper).offset().top+"px",this.dom.pointer.style.height=t("div.dataTables_scroll",this.s.dt.nTableWrapper).height()+"px"),i.body.appendChild(this.dom.pointer),i.body.appendChild(this.dom.drag)}},ColReorder.aoInstances=[],ColReorder.fnReset=function(t){for(var e=0,i=ColReorder.aoInstances.length;i>e;e++)ColReorder.aoInstances[e].s.dt.oInstance==t&&ColReorder.aoInstances[e].fnReset()},ColReorder.prototype.CLASS="ColReorder",ColReorder.VERSION="1.0.6",ColReorder.prototype.VERSION=ColReorder.VERSION,typeof t.fn.dataTable=="function"&&typeof t.fn.dataTableExt.fnVersionCheck=="function"&&t.fn.dataTableExt.fnVersionCheck("1.9.0")?t.fn.dataTableExt.aoFeatures.push({fnInit:function(t){var e=t.oInstance;if(typeof e._oPluginColReorder=="undefined"){var i=typeof t.oInit.oColReorder!="undefined"?t.oInit.oColReorder:{};e._oPluginColReorder=new ColReorder(t.oInstance,i)}else e.oApi._fnLog(t,1,"ColReorder attempted to initialise twice. Ignoring second");return null},cFeature:"R",sFeature:"ColReorder"}):alert("Warning: ColReorder requires DataTables 1.9.0 or greater - www.datatables.net/download")})(jQuery,window,document);